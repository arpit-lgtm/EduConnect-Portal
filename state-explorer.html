<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Universities by State - EduConnect</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/ai-recommendation.css">
    <link rel="stylesheet" href="assets/css/popular-programs.css">
    <link rel="stylesheet" href="assets/css/course-comparison-system.css">
    <link rel="stylesheet" href="assets/css/enhanced-ai-questionnaire.css">
    
    <style>
        body {
            background-color: #f8fafc;
        }
        
        .state-explorer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .explorer-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
        }
        
        .explorer-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .explorer-header p {
            font-size: 0.95rem;
            opacity: 0.95;
        }
        
        .state-selector {
            background: white;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .selector-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .state-dropdown {
            max-width: 100%;
        }
        
        .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .explore-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .explore-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .explore-btn:active {
            transform: translateY(0);
        }
        
        .results-section {
            margin-top: 2rem;
        }
        
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .university-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .university-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="state-explorer-container">
        <!-- Header Section -->
        <div class="explorer-header">
            <h1><i class="fas fa-map-marked-alt me-3"></i>Explore Universities by State</h1>
            <p class="mb-0">Discover universities offering <strong id="course-name-display">your selected course</strong> across different states in India</p>
        </div>

        <!-- State Selector -->
        <div class="state-selector">
            <div class="selector-title">
                <i class="fas fa-location-dot text-primary"></i>
                Select State to Explore Universities
            </div>
            
            <div class="state-dropdown">
                <div class="row g-2 align-items-end">
                    <div class="col-md-9">
                        <select id="stateSelector" class="form-select">
                            <option value="">Choose a State...</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button id="exploreBtn" class="btn explore-btn w-100" onclick="exploreSelectedState()">
                            <i class="fas fa-search me-2"></i>Explore
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section" style="display: none;">
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Unified Database Script -->
    <script src="public/assets/js/comprehensive-unified-database-COMPLETE.js"></script>
    <script src="public/assets/js/enhanced-ai-questionnaire-comprehensive.js"></script>
    
    <!-- State Explorer Script -->
    <script>
        let currentCourse = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadHeaderAndFooter();
            extractCourseFromUrl();
        });

        // Load header and footer
        function loadHeaderAndFooter() {
            // Load header
            fetch('includes/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-placeholder').innerHTML = data;
                })
                .catch(error => console.error('Error loading header:', error));

            // Load footer
            fetch('includes/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-placeholder').innerHTML = data;
                })
                .catch(error => console.error('Error loading footer:', error));
        }

        // Extract course name from URL
        function extractCourseFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            currentCourse = urlParams.get('course') || 'Selected Course';
            document.getElementById('course-name-display').textContent = currentCourse;
            document.title = `Explore ${currentCourse} Universities by State - EduConnect`;
        }

        // Explore selected state
        function exploreSelectedState() {
            const stateSelector = document.getElementById('stateSelector');
            const selectedState = stateSelector.value;
            
            if (!selectedState) {
                alert('Please select a state to explore universities.');
                return;
            }

            console.log('🌍 Exploring universities in state:', selectedState, 'for course:', currentCourse);
            
            // Show loading
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <h4>Searching Universities...</h4>
                    <p>Finding universities offering ${currentCourse} in ${selectedState}</p>
                </div>
            `;

            // Simulate loading delay and then search
            setTimeout(() => {
                searchUniversitiesByState(selectedState);
            }, 500);
        }

        // Search universities by state
        function searchUniversitiesByState(stateName) {
            console.log('🔍 Searching for universities in:', stateName);
            
            // Check if database is available
            if (typeof universityDatabase === 'undefined' || !universityDatabase) {
                showError('University database is not available. Please refresh the page.');
                return;
            }

            // Filter universities by state
            const stateUniversities = universityDatabase.filter(university => {
                const location = (university.location || '').toLowerCase();
                const state = stateName.toLowerCase();
                return location.includes(state);
            });

            console.log(`🏫 Found ${stateUniversities.length} universities in ${stateName}`);

            if (stateUniversities.length === 0) {
                showNoResults(stateName);
                return;
            }

            // Sort universities alphabetically
            stateUniversities.sort((a, b) => a.name.localeCompare(b.name));

            // Display results
            displayUniversities(stateUniversities, stateName);
        }

        // Display universities using the questionnaire's rendering system
        function displayUniversities(universities, stateName) {
            const resultsContent = document.getElementById('resultsContent');
            
            // Check if enhancedAI is available
            if (typeof enhancedAI !== 'undefined' && enhancedAI.renderUniversityRecommendations) {
                console.log('✅ Using enhanced AI rendering system');
                
                // Create a temporary container
                const tempDiv = document.createElement('div');
                tempDiv.id = 'university-recommendations-list';
                resultsContent.innerHTML = '';
                resultsContent.appendChild(tempDiv);
                
                // Add header
                const headerHtml = `
                    <div class="mb-4 p-4 rounded-3" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                    ">
                        <h4 class="mb-2">
                            <i class="fas fa-university me-2"></i>
                            Universities in ${stateName}
                        </h4>
                        <p class="mb-0">Found ${universities.length} universities offering ${currentCourse}</p>
                    </div>
                `;
                resultsContent.insertAdjacentHTML('afterbegin', headerHtml);
                
                // Use the questionnaire's rendering function
                enhancedAI.renderUniversityRecommendations(tempDiv, universities, currentCourse, {});
                
                // Add reset button at the end
                resultsContent.insertAdjacentHTML('beforeend', `
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary" onclick="resetSearch()">
                            <i class="fas fa-search me-2"></i>Search Another State
                        </button>
                    </div>
                `);
            } else {
                console.log('⚠️ Enhanced AI not available, using fallback rendering');
                // Fallback to basic rendering
                displayUniversitiesFallback(universities, stateName);
            }
        }
        
        // Fallback rendering if enhancedAI is not available
        function displayUniversitiesFallback(universities, stateName) {
            const resultsContent = document.getElementById('resultsContent');
            const universitiesHtml = universities.map((uni, index) => 
                generateBasicUniversityCard(uni, index + 1)
            ).join('');
            
            resultsContent.innerHTML = `
                <div class="mb-4 p-3 bg-primary text-white rounded">
                    <h4 class="mb-2">
                        <i class="fas fa-university me-2"></i>
                        Universities in ${stateName}
                    </h4>
                    <p class="mb-0">Found ${universities.length} universities offering ${currentCourse}</p>
                </div>
                
                ${universitiesHtml}
                
                <div class="text-center mt-4">
                    <button class="btn btn-outline-primary" onclick="resetSearch()">
                        <i class="fas fa-search me-2"></i>Search Another State
                    </button>
                </div>
            `;
        }
        
        // Generate basic university card (simplified version for fallback)
        function generateBasicUniversityCard(university, rank) {
            // Debug fees data
            console.log(`💰 Generating card for ${university.name}:`, {
                fees: university.fees,
                feesType: typeof university.fees,
                hasFeesMin: university.fees?.min,
                hasFeesMax: university.fees?.max
            });
            
            // Generate rating stars
            const rating = university.rating || 4.0;
            const stars = '⭐'.repeat(Math.floor(rating)) + (rating % 1 ? '✨' : '');
            
            // Generate fees display - Enhanced with multiple formats
            let feesText = 'Contact for fees';
            let feesColor = '#166534'; // Default green
            
            // Helper function to format fees
            const formatFee = (amount) => {
                if (amount >= 100000) {
                    // 1 lakh and above - show in lakhs
                    return `₹${(amount / 100000).toFixed(1)}L`;
                } else if (amount >= 1000) {
                    // 1K to 99K - show in thousands
                    return `₹${Math.round(amount / 1000)}K`;
                } else {
                    // Less than 1K - show as is
                    return `₹${amount.toLocaleString()}`;
                }
            };

            if (university.fees) {
                if (university.fees.min && university.fees.max && university.fees.min !== university.fees.max) {
                    // Range format
                    feesText = `${formatFee(university.fees.min)} - ${formatFee(university.fees.max)}`;
                } else if (university.fees.min) {
                    // Single fee from min
                    feesText = `${formatFee(university.fees.min)}/year`;
                } else if (university.fees.max) {
                    // Single fee from max
                    feesText = `${formatFee(university.fees.max)}/year`;
                } else if (typeof university.fees === 'number') {
                    // Direct number
                    feesText = `${formatFee(university.fees)}/year`;
                }
                
                // Color coding based on fee range
                const avgFee = university.fees.min || university.fees.max || university.fees;
                if (avgFee <= 50000) {
                    feesColor = '#059669'; // Green for low fees
                } else if (avgFee <= 200000) {
                    feesColor = '#d97706'; // Orange for medium fees  
                } else {
                    feesColor = '#dc2626'; // Red for high fees
                }
            }
            
            // Get percentage rating and explanation from course database if available
            let matchRating = '';
            let matchExplanation = '';
            if (university.matchRating) {
                matchRating = `
                    <div style="
                        display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;
                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                        border: 1px solid #fbbf24; color: #92400e;
                        padding: 0.375rem 0.75rem; border-radius: 8px;
                        font-size: 0.875rem; font-weight: 700;
                    ">
                        🎯 ${university.matchRating}% Match
                    </div>
                `;
            }
            if (university.matchExplanation) {
                matchExplanation = `
                    <div style="
                        margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                        border-left: 4px solid #3b82f6; border-radius: 8px;
                    ">
                        <p style="margin: 0; font-size: 0.9rem; line-height: 1.5; color: #1e40af; font-weight: 500;">
                            💡 <strong>Why This University:</strong> ${university.matchExplanation}
                        </p>
                    </div>
                `;
            }
            
            return `
                <div class="university-card" style="
                    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                    border: 1px solid rgba(148, 163, 184, 0.1);
                    border-radius: 20px; padding: 2rem; position: relative;
                    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.08), 0 3px 10px rgba(15, 23, 42, 0.03);
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden; cursor: pointer; margin-bottom: 1.5rem;
                " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 20px 40px rgba(15, 23, 42, 0.12), 0 8px 16px rgba(15, 23, 42, 0.05)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(15, 23, 42, 0.08), 0 3px 10px rgba(15, 23, 42, 0.03)'">
                    
                    <!-- University Header -->
                    <div style="display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="
                            flex-shrink: 0; width: 4rem; height: 4rem;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 16px; display: flex; align-items: center; justify-content: center;
                            color: white; font-size: 1.5rem; font-weight: 700;
                            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
                        ">${rank}</div>
                        
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="
                                margin: 0 0 0.5rem 0; font-size: 1.375rem; font-weight: 700;
                                color: #1e293b; line-height: 1.3; font-family: 'Inter', sans-serif;
                            ">${university.name}</h4>
                            
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <span style="color: #64748b; font-size: 0.875rem;">📍</span>
                                    <span style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                                        ${university.location}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <span style="font-size: 0.875rem;">${stars}</span>
                                    <span style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                                        ${rating.toFixed(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- University Details Row -->
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem;">
                                ${university.accreditation && !university.accreditation.toLowerCase().includes('nirf') ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                                        border: 1px solid #a7f3d0; color: #059669;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        🏆 ${university.accreditation}
                                    </div>
                                ` : ''}
                                
                                ${university.nirfRanking ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                        border: 1px solid #fbbf24; color: #92400e;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        🏅 NIRF #${university.nirfRanking}
                                    </div>
                                ` : ''}
                                
                                ${university.approvals && university.approvals.length > 0 ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
                                        border: 1px solid #a5b4fc; color: #3730a3;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        ✅ ${university.approvals.slice(0, 2).join(', ')}${university.approvals.length > 2 ? ' +' + (university.approvals.length - 2) : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                <div style="
                                    display: inline-flex; align-items: center; gap: 0.5rem;
                                    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                    border: 1px solid #bbf7d0; color: ${feesColor};
                                    padding: 0.375rem 0.75rem; border-radius: 8px;
                                    font-size: 0.875rem; font-weight: 600;
                                ">
                                    💰 ${feesText}
                                </div>
                                ${matchRating}
                            </div>
                        </div>
                    </div>
                    
                    ${matchExplanation}
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 1.5rem;">
                        <button onclick="contactUniversity('${university.name.replace(/'/g, "\\'")}')" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; padding: 0.875rem 1.5rem;
                            border-radius: 12px; font-weight: 600; cursor: pointer;
                            transition: all 0.3s ease; font-size: 0.9rem; width: 100%;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                            📞 Get Free Counseling
                        </button>
                    </div>
                </div>
            `;
        }

        // Display universities using same design as main questionnaire
        function displayUniversities(universities, stateName) {
            const resultsContent = document.getElementById('resultsContent');
            
            const universitiesHtml = universities.map((university, index) => {
                return generateProfessionalUniversityCard(university, index + 1);
            }).join('');
            resultsContent.innerHTML = `
                <div class="mb-4 p-3 bg-primary text-white rounded">
                    <h4 class="mb-2">
                        <i class="fas fa-university me-2"></i>
                        Universities in ${stateName}
                    </h4>
                    <p class="mb-0">Found ${universities.length} universities offering ${currentCourse}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem;">
                    ${universitiesHtml}
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-outline-primary" onclick="resetSearch()">
                        <i class="fas fa-search me-2"></i>Search Another State
                    </button>
                </div>
            `;
        }

        // Generate professional university card (same as main questionnaire)
        function generateProfessionalUniversityCard(university, rank) {
            // Generate rating stars
            const rating = university.rating || 4.0;
            const stars = '⭐'.repeat(Math.floor(rating)) + (rating % 1 ? '✨' : '');
            
            // Generate fees display
            let feesText = 'Contact for fees';
            let feesColor = '#166534'; // Default green
            
            // Helper function to format fees
            const formatFee = (amount) => {
                if (amount >= 100000) {
                    return `₹${(amount / 100000).toFixed(1)}L`;
                } else if (amount >= 1000) {
                    return `₹${Math.round(amount / 1000)}K`;
                } else {
                    return `₹${amount.toLocaleString()}`;
                }
            };

            if (university.fees) {
                if (university.fees.min && university.fees.max && university.fees.min !== university.fees.max) {
                    feesText = `${formatFee(university.fees.min)} - ${formatFee(university.fees.max)}`;
                } else if (university.fees.min) {
                    feesText = `${formatFee(university.fees.min)}/year`;
                } else if (university.fees.max) {
                    feesText = `${formatFee(university.fees.max)}/year`;
                } else if (typeof university.fees === 'number') {
                    feesText = `${formatFee(university.fees)}/year`;
                }
                
                const avgFee = university.fees.min || university.fees.max || university.fees;
                if (avgFee <= 50000) {
                    feesColor = '#059669'; // Green for low fees
                } else if (avgFee <= 200000) {
                    feesColor = '#d97706'; // Orange for medium fees  
                } else {
                    feesColor = '#dc2626'; // Red for high fees
                }
            }
            
            // Get match rating if available
            let matchRating = '';
            if (university.matchRating) {
                matchRating = `
                    <div style="
                        display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;
                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                        border: 1px solid #fbbf24; color: #92400e;
                        padding: 0.375rem 0.75rem; border-radius: 8px;
                        font-size: 0.875rem; font-weight: 700;
                    ">
                        🎯 ${university.matchRating}% Match
                    </div>
                `;
            }
            
            return `
                <div style="
                    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                    border: 1px solid rgba(148, 163, 184, 0.1);
                    border-radius: 20px; padding: 2rem; position: relative;
                    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.08), 0 3px 10px rgba(15, 23, 42, 0.03);
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden; cursor: pointer;
                " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 20px 40px rgba(15, 23, 42, 0.12), 0 8px 16px rgba(15, 23, 42, 0.05)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(15, 23, 42, 0.08), 0 3px 10px rgba(15, 23, 42, 0.03)'">
                    
                    <!-- University Header -->
                    <div style="display: flex; align-items: flex-start; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="
                            flex-shrink: 0; width: 4rem; height: 4rem;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 16px; display: flex; align-items: center; justify-content: center;
                            color: white; font-size: 1.5rem; font-weight: 700;
                            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
                        ">${rank}</div>
                        
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="
                                margin: 0 0 0.5rem 0; font-size: 1.375rem; font-weight: 700;
                                color: #1e293b; line-height: 1.3; font-family: 'Inter', sans-serif;
                            ">${university.name}</h4>
                            
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <span style="color: #64748b; font-size: 0.875rem;">📍</span>
                                    <span style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                                        ${university.location}
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.375rem;">
                                    <span style="font-size: 0.875rem;">${stars}</span>
                                    <span style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                                        ${rating.toFixed(1)}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- University Details Row -->
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem;">
                                ${university.accreditation && !university.accreditation.toLowerCase().includes('nirf') ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                                        border: 1px solid #a7f3d0; color: #059669;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        🏆 ${university.accreditation}
                                    </div>
                                ` : ''}
                                
                                ${university.nirfRanking ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                                        border: 1px solid #fbbf24; color: #92400e;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        🏅 NIRF #${university.nirfRanking}
                                    </div>
                                ` : ''}
                                
                                ${university.approvals && university.approvals.length > 0 ? `
                                    <div style="
                                        display: inline-flex; align-items: center; gap: 0.375rem;
                                        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
                                        border: 1px solid #a5b4fc; color: #3730a3;
                                        padding: 0.25rem 0.5rem; border-radius: 6px;
                                        font-size: 0.75rem; font-weight: 600;
                                    ">
                                        ✅ ${university.approvals.slice(0, 2).join(', ')}${university.approvals.length > 2 ? ' +' + (university.approvals.length - 2) : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                                <div style="
                                    display: inline-flex; align-items: center; gap: 0.5rem;
                                    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                    border: 1px solid #bbf7d0; color: ${feesColor};
                                    padding: 0.375rem 0.75rem; border-radius: 8px;
                                    font-size: 0.875rem; font-weight: 600;
                                ">
                                    💰 ${feesText}
                                </div>
                                ${matchRating}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 1.5rem;">
                        <button onclick="contactUniversity('${university.name.replace(/'/g, "\\'")}')" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; border: none; padding: 0.875rem 1.5rem;
                            border-radius: 12px; font-weight: 600; cursor: pointer;
                            transition: all 0.3s ease; font-size: 0.9rem; width: 100%;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                            📞 Get Free Counseling
                        </button>
                    </div>
                </div>
            `;
        }

        // Show no results
        function showNoResults(stateName) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>No Universities Found</h4>
                    <p>No universities found in ${stateName} offering ${currentCourse}.</p>
                    <button class="btn btn-primary" onclick="resetSearch()">
                        <i class="fas fa-search me-2"></i>Try Another State
                    </button>
                </div>
            `;
        }

        // Show error
        function showError(message) {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h4>Error</h4>
                    <p>${message}</p>
                    <button class="btn btn-danger" onclick="location.reload()">
                        <i class="fas fa-refresh me-2"></i>Refresh Page
                    </button>
                </div>
            `;
        }

        // Reset search
        function resetSearch() {
            document.getElementById('stateSelector').value = '';
            document.getElementById('resultsSection').style.display = 'none';
        }

        // Note: contactUniversity is provided by enhanced-ai-questionnaire-comprehensive.js
        // It shows a beautiful modal with expert consultation form
    </script>
</body>
</html>